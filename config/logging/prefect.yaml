# Custom Prefect logging configuration for QDash.
#
# Adds a RotatingFileHandler so that flow/task run logs are written to
# /app/logs/prefect.log in JSON format, matching the API logging style.
#
# Any item can be overridden with an environment variable:
#   PREFECT_LOGGING_[PATH]_[TO]_[KEY]=VALUE

version: 1
disable_existing_loggers: False

formatters:
  simple:
    format: "%(asctime)s.%(msecs)03d | %(message)s"
    datefmt: "%H:%M:%S"

  standard:
    (): prefect.logging.formatters.PrefectFormatter
    format: "%(asctime)s.%(msecs)03d | %(levelname)-7s | %(name)s - %(message)s"
    flow_run_fmt: "%(asctime)s.%(msecs)03d | %(levelname)-7s | Flow run %(flow_run_name)r - %(message)s"
    task_run_fmt: "%(asctime)s.%(msecs)03d | %(levelname)-7s | Task run %(task_run_name)r - %(message)s"
    datefmt: "%H:%M:%S"

  debug:
    format: "%(asctime)s.%(msecs)03d | %(levelname)-7s | %(threadName)-12s | %(name)s - %(message)s"
    datefmt: "%H:%M:%S"

  json:
    class: prefect.logging.formatters.JsonFormatter
    format: "default"

handlers:
  console:
    level: 0
    class: prefect.logging.handlers.PrefectConsoleHandler
    formatter: standard
    stream: ext://sys.stderr

  api:
    level: 0
    class: prefect.logging.handlers.APILogHandler

  debug:
    level: 0
    class: logging.StreamHandler
    formatter: debug
    stream: ext://sys.stderr

  worker_api:
    level: 0
    class: prefect.logging.handlers.WorkerAPILogHandler

  file:
    level: 0
    class: logging.handlers.RotatingFileHandler
    formatter: json
    filename: /app/logs/prefect.log
    maxBytes: 10485760  # 10 MB
    backupCount: 5
    encoding: utf8

loggers:
  prefect:
    level: "${PREFECT_LOGGING_LEVEL}"

  prefect.extra:
    level: "${PREFECT_LOGGING_LEVEL}"
    handlers: [api]
    propagate: false

  prefect.flow_runs:
    level: NOTSET
    handlers: [api, file]

  prefect.task_runs:
    level: NOTSET
    handlers: [api, file]

  prefect.workers:
    level: NOTSET
    handlers: [worker_api, file]

  prefect.server:
    level: "${PREFECT_SERVER_LOGGING_LEVEL}"

  prefect.client:
    level: "${PREFECT_LOGGING_LEVEL}"

  prefect.infrastructure:
    level: "${PREFECT_LOGGING_LEVEL}"

  prefect._internal:
    level: "${PREFECT_INTERNAL_LOGGING_LEVEL}"
    propagate: false
    handlers: [debug]

  uvicorn:
    level: WARNING
    handlers: [console]
    propagate: false

  fastapi:
    level: WARNING
    handlers: [console]
    propagate: false

root:
  level: WARNING
  handlers: [console]
